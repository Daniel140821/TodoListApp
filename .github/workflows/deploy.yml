name: Hybrid Build (Cloud & SideStore)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: 

jobs:
  build-all:
    runs-on: macos-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ========================================================
      # 1Ô∏è‚É£ Á¨¨‰∏ÄÈò∂ÊÆµÔºöÊûÑÂª∫Ê®°ÊãüÂô®Áâà (Áªô Appetize ‰∫ëÈ¢ÑËßà)
      # ========================================================
      - name: Build for Simulator (Appetize)
        run: |
          SCHEME_NAME="TodoListApp"
          PROJECT_FILE=$(find . -name "*.xcodeproj" -maxdepth 2 | head -n 1)
          
          echo "üñ•Ô∏è Ê≠£Âú®ÊûÑÂª∫Ê®°ÊãüÂô®ÁâàÊú¨ (‰ΩøÁî®ÈÄöÁî® SDK)..."
          
          # ‰ΩøÁî® -sdk iphonesimulator ÈÅøÂÖçÊâæ‰∏çÂà∞ÂÖ∑‰ΩìËÆæÂ§áÁöÑÈóÆÈ¢ò
          xcodebuild build \
            -project "$PROJECT_FILE" \
            -scheme "$SCHEME_NAME" \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath build_sim \
            IPHONEOS_DEPLOYMENT_TARGET=17.0 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Zip Simulator App
        run: |
          # ËøõÂÖ•ÊûÑÂª∫‰∫ßÁâ©ÁõÆÂΩï (Ê≥®ÊÑèË∑ØÂæÑÂøÖÈ°ªÂåπÈÖç SDK)
          cd build_sim/Build/Products/Debug-iphonesimulator/
          
          # Ëá™Âä®ÊâæÂà∞ .app Êñá‰ª∂
          APP_NAME=$(find . -name "*.app" -maxdepth 1 -exec basename {} \;)
          
          echo "üì¶ Ê≠£Âú®ÊâìÂåÖ: $APP_NAME"
          zip -r ../../../../simulator_app.zip "$APP_NAME"

      - name: Upload to Appetize & Generate Link
        env:
          TOKEN: ${{ secrets.APPETIZE_TOKEN }}
        run: |
          echo "‚òÅÔ∏è Ê≠£Âú®‰∏ä‰º†Âà∞ Appetize..."
          
          # Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶Â≠òÂú®
          if [ ! -f "simulator_app.zip" ]; then
            echo "‚ùå ÈîôËØØÔºöÊâæ‰∏çÂà∞ simulator_app.zip"
            exit 1
          fi

          response=$(curl -s -X POST https://$TOKEN@api.appetize.io/v1/apps \
            -F "file=@simulator_app.zip" \
            -F "platform=ios")
          
          # ÁÆÄÂçïÁöÑ JSON Ëß£Êûê (ÊèêÂèñ publicKey)
          publicKey=$(echo $response | python3 -c "import sys, json; print(json.load(sys.stdin)['publicKey'])")
          
          if [ -z "$publicKey" ] || [ "$publicKey" == "null" ]; then
             echo "‚ùå ‰∏ä‰º†Â§±Ë¥•ÔºåAppetize ÂìçÂ∫î: $response"
             exit 1
          fi

          # ÁîüÊàêÈìæÊé• (‰ΩøÁî® iPhone 15 ‰Ωú‰∏∫ÊòæÁ§∫Êú∫Âûã)
          PREVIEW_URL="https://appetize.io/app/$publicKey?device=iphone15pro&osVersion=17.0&scale=100&orientation=portrait"
          
          echo "### ‚úÖ Ê®°ÊãüÂô®È¢ÑËßàÂ∞±Áª™" >> $GITHUB_STEP_SUMMARY
          echo "üîó [**ÁÇπÂáªÂú®Á∫øËøêË°å App**]($PREVIEW_URL)" >> $GITHUB_STEP_SUMMARY

      # ========================================================
      # 2Ô∏è‚É£ Á¨¨‰∫åÈò∂ÊÆµÔºöÊûÑÂª∫ÁúüÊú∫Áâà (Áªô SideStore ÂÆâË£Ö)
      # ========================================================
      - name: Build for Real Device (SideStore)
        run: |
          SCHEME_NAME="BookofAnswers"
          PROJECT_FILE=$(find . -name "*.xcodeproj" -maxdepth 2 | head -n 1)
          
          echo "üì± Ê≠£Âú®ÊûÑÂª∫ÁúüÊú∫ IPA..."
          
          xcodebuild build \
            -project "$PROJECT_FILE" \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build_real \
            IPHONEOS_DEPLOYMENT_TARGET=17.0 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
            
          # ÊâìÂåÖ IPA
          cd build_real/Build/Products/Release-iphoneos/
          APP_NAME=$(find . -name "*.app" -maxdepth 1 -exec basename {} \;)
          
          mkdir Payload
          cp -r "$APP_NAME" Payload/
          zip -r app-unsigned.ipa Payload

      # ========================================================
      # 3Ô∏è‚É£ ‰∏ä‰º† IPA
      # ========================================================
      - name: Upload SideStore IPA
        uses: actions/upload-artifact@v4
        with:
          name: SideStore-Installable-IPA
          path: build_real/Build/Products/Release-iphoneos/app-unsigned.ipa
          retention-days: 5
